<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Management - B2B Platform</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo"><a href="../index.html" style="color: white; text-decoration: none;">Admin Panel</a></div>
            <ul>
                <li><a href="admin-dashboard.html">Dashboard</a></li>
                <li><a href="admin-orders.html">Orders</a></li>
                <li><a href="admin-partners.html">Partners</a></li>
                <li><a href="admin-rewards.html">Rewards</a></li>
                <li><a href="admin-invoices.html">Invoices</a></li>
                <li><a href="../index.html">Public Site</a></li>
                <li><a href="#" onclick="logout(); return false;">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="d-flex justify-between align-center" style="margin-bottom: 1rem;">
            <h1>Partner Management</h1>
            <button class="btn btn-primary" onclick="openPartnerModal()">Create Partner</button>
        </div>

        <div class="card" style="margin-bottom: 1rem;">
            <input type="text" id="searchInput" placeholder="Search by company name, email, or contact person..." 
                   style="width: 100%; padding: 0.75rem;" oninput="loadPartners()">
        </div>

        <div class="card" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>Contact Person</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Total Spend</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="partnersTable">
                    <tr><td colspan="7" class="text-center">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Partner Modal -->
    <div id="partnerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: white; padding: 2rem; border-radius: 8px; min-width: 400px; max-width: 600px; margin-bottom: 50px;">
            <h3 id="modalTitle">Create New Partner</h3>
            <div id="alertMessage"></div>
            <form id="partnerForm">
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" required>
                    <small id="passwordHint" style="display: none; color: #666;">Leave blank to keep current password</small>
                </div>
                <div class="form-group">
                    <label for="companyName">Company Name *</label>
                    <input type="text" id="companyName" required>
                </div>
                <div class="form-group">
                    <label for="contactPerson">Contact Person *</label>
                    <input type="text" id="contactPerson" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="text" id="phone">
                </div>
                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address" rows="3"></textarea>
                </div>
                <div class="d-flex gap-2" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePartnerModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/localStorageService.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        if (!requireAuth('admin')) return;

        let editingPartnerId = null;

        function loadPartners() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let partners = localStorageService.getUsers().filter(u => u.role === 'partner');

            if (searchTerm) {
                partners = partners.filter(p =>
                    p.companyName?.toLowerCase().includes(searchTerm) ||
                    p.email?.toLowerCase().includes(searchTerm) ||
                    p.contactPerson?.toLowerCase().includes(searchTerm)
                );
            }

            const tbody = document.getElementById('partnersTable');
            
            if (partners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No partners found</td></tr>';
                return;
            }

            tbody.innerHTML = partners.map(partner => `
                <tr>
                    <td>${partner.companyName}</td>
                    <td>${partner.contactPerson}</td>
                    <td>${partner.email}</td>
                    <td>${partner.phone || 'N/A'}</td>
                    <td>â‚¹${(partner.totalSpend || 0).toLocaleString('en-IN')}</td>
                    <td><span class="badge ${partner.isActive ? 'badge-success' : 'badge-secondary'}">${partner.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem; margin-right: 0.5rem;" 
                                onclick="editPartner('${partner._id}')">Edit</button>
                        ${partner.isActive ? `<button class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" 
                                onclick="deactivatePartner('${partner._id}')">Deactivate</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function openPartnerModal(partnerId = null) {
            editingPartnerId = partnerId;
            const modal = document.getElementById('partnerModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('partnerForm');
            const passwordInput = document.getElementById('password');
            const passwordHint = document.getElementById('passwordHint');

            if (partnerId) {
                const partner = localStorageService.getUser(partnerId);
                title.textContent = 'Edit Partner';
                document.getElementById('email').value = partner.email;
                document.getElementById('password').value = '';
                document.getElementById('password').required = false;
                passwordHint.style.display = 'block';
                document.getElementById('companyName').value = partner.companyName;
                document.getElementById('contactPerson').value = partner.contactPerson;
                document.getElementById('phone').value = partner.phone || '';
                document.getElementById('address').value = partner.address || '';
            } else {
                title.textContent = 'Create New Partner';
                form.reset();
                passwordInput.required = true;
                passwordHint.style.display = 'none';
            }
            modal.style.display = 'block';
        }

        function closePartnerModal() {
            document.getElementById('partnerModal').style.display = 'none';
            editingPartnerId = null;
            document.getElementById('alertMessage').innerHTML = '';
        }

        function editPartner(partnerId) {
            openPartnerModal(partnerId);
        }

        function deactivatePartner(partnerId) {
            if (confirm('Are you sure you want to deactivate this partner?')) {
                localStorageService.updateUser(partnerId, { isActive: false });
                loadPartners();
            }
        }

        document.getElementById('partnerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const alertDiv = document.getElementById('alertMessage');
            
            const data = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                companyName: document.getElementById('companyName').value,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };

            if (editingPartnerId) {
                // Check if email changed
                const existing = localStorageService.getUser(editingPartnerId);
                if (data.email !== existing.email) {
                    const emailExists = localStorageService.getUserByEmail(data.email);
                    if (emailExists) {
                        alertDiv.innerHTML = '<div class="alert alert-error">Email already in use</div>';
                        return;
                    }
                }

                const updates = { ...data };
                if (!data.password) {
                    delete updates.password;
                }
                localStorageService.updateUser(editingPartnerId, updates);
                alertDiv.innerHTML = '<div class="alert alert-success">Partner updated successfully!</div>';
            } else {
                // Check if email exists
                const emailExists = localStorageService.getUserByEmail(data.email);
                if (emailExists) {
                    alertDiv.innerHTML = '<div class="alert alert-error">Email already in use</div>';
                    return;
                }

                localStorageService.addUser({
                    ...data,
                    role: 'partner',
                    isActive: true,
                    totalSpend: 0
                });
                alertDiv.innerHTML = '<div class="alert alert-success">Partner created successfully!</div>';
            }

            setTimeout(() => {
                closePartnerModal();
                loadPartners();
            }, 1000);
        });

        // Close modal on outside click
        document.getElementById('partnerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePartnerModal();
            }
        });

        loadPartners();
    </script>
</body>
</html>

